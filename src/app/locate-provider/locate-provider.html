<app-app-header title="Localizar Proveedor y Pedidos" subtitle="Búsqueda y gestión de proveedores" />

<p-toast />

<app-page-container maxWidth="6xl">
  <div class="mb-4 sm:mb-6 flex items-center text-xs sm:text-sm text-gray-500 dark:text-gray-400">
    <p-button 
      icon="pi pi-arrow-left"
      label="Volver al Dashboard"
      [text]="true"
      (onClick)="onBackToDashboard()" />
  </div>

  <div class="min-h-screen flex flex-col gap-3 sm:gap-4">
    <!-- Búsqueda -->
    <app-app-card class="card-no-padding">
      <div class="p-4 sm:p-6 max-w-2xl w-full">
        <label class="block text-xs sm:text-sm font-medium text-gray-700 dark:text-gray-300 mb-1 sm:mb-2" for="supplier-search">
          Buscar Distribuidor
        </label>
        <app-supplier-autocomplete
          placeholder="Nombre o RIF"
          [suggestions]="supplierSuggestions"
          [loading]="searchLoading"
          (search)="onSearch($event)"
          (select)="onSupplierSelect($event)"
          (focus)="onFocus()">
        </app-supplier-autocomplete>
        <p class="mt-1 sm:mt-2 text-[10px] sm:text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
          <i class="pi pi-info-circle text-xs sm:text-sm shrink-0"></i>
          <span>Haga clic en el campo para ver todos los distribuidores o escriba para buscar.</span>
        </p>
      </div>
    </app-app-card>

    <!-- Resultados -->
    @if (provider) {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 sm:gap-6 lg:gap-8 items-start">
      <!-- Columna Izquierda: Resumen y Deudas -->
      <div class="space-y-0 min-w-0">
        <app-app-card class="card-no-padding">
          <!-- Resumen del Proveedor -->
          <div class="relative z-10 px-4 py-3 sm:px-6 sm:py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50 flex flex-nowrap items-center justify-between gap-2 min-h-[3rem]">
            <div class="flex items-center gap-2 min-w-0 flex-1 overflow-hidden">
              <i class="pi pi-info-circle text-primary text-base sm:text-lg shrink-0"></i>
              <h3 class="text-base sm:text-lg font-semibold text-slate-800 dark:text-white truncate">Resumen del Proveedor</h3>
            </div>
            @if (canEditProviderAndDebts) {
            <div class="flex items-center justify-center shrink-0">
              <p-button
                icon="pi pi-ellipsis-v"
                [text]="true"
                severity="secondary"
                [rounded]="true"
                size="small"
                (onClick)="providerMenu.toggle($event)"
                [pTooltip]="'Acciones'"
                tooltipPosition="top" />
              <p-menu
                #providerMenu
                [model]="getProviderMenuItems()"
                [popup]="true"
                [appendTo]="'body'" />
            </div>
            }
          </div>

          <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
            <!-- Información del Proveedor -->
            <div class="min-w-0">
              <label class="block text-[10px] sm:text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-0.5 sm:mb-1">
                Nombre Proveedor
              </label>
              <div class="text-lg sm:text-xl md:text-2xl font-bold text-slate-900 dark:text-white break-words">
                {{ provider!.companyName }}
              </div>
            </div>

            @if (provider!.taxId) {
            <div>
              <label class="block text-[10px] sm:text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-0.5 sm:mb-1">
                RIF / ID Fiscal
              </label>
              <div class="text-base sm:text-lg text-slate-800 dark:text-slate-200 font-medium">
                {{ provider!.taxId }}
              </div>
            </div>
            }

                  <div [ngClass]="{
                    'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-800/30': totalDebt() > 0,
                    'bg-green-50 dark:bg-green-900/20 border-green-100 dark:border-green-800/30': totalDebt() <= 0
                  }" class="p-3 sm:p-4 rounded-lg border">
                    <label [ngClass]="totalDebt() > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'" 
                      class="block text-[10px] sm:text-xs font-medium uppercase tracking-wider mb-0.5 sm:mb-1">
                      Deuda Actualizada
                    </label>
                    <div [ngClass]="totalDebt() > 0 ? 'text-red-700 dark:text-red-400' : 'text-green-700 dark:text-green-400'" 
                      class="text-xl sm:text-2xl font-bold font-mono">
                      $ {{ totalDebt().toFixed(2) }}
                    </div>
                    @if (totalDebt() > 0) {
                      <p class="text-[10px] sm:text-xs text-red-500 mt-0.5 sm:mt-1">Requiere atención</p>
                    } @else {
                      <p class="text-[10px] sm:text-xs text-green-500 mt-0.5 sm:mt-1">Al día / Sin deudas</p>
                    }
                  </div>

            <div class="grid grid-cols-2 gap-3 sm:gap-6">
              <div class="min-w-0">
                <label class="block text-[10px] sm:text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-0.5 sm:mb-1">
                  Estado
                </label>
                <div class="text-sm sm:text-base text-slate-800 dark:text-slate-200 font-medium flex items-center gap-2">
                  <i class="pi pi-info-circle text-blue-500 text-xs sm:text-sm shrink-0"></i>
                  {{ provider!.status === 'PENDING' ? 'Pendiente' : 'Completado' }}
                </div>
              </div>
              <div class="min-w-0">
                <label class="block text-[10px] sm:text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-0.5 sm:mb-1">
                  Último Pago/Abono
                </label>
                <div class="text-sm sm:text-base text-slate-800 dark:text-slate-200 font-medium">
                  {{ provider!.lastPaymentDate ? (provider!.lastPaymentDate | date:'dd/MM/yyyy') : 'N/A' }}
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de Deudas -->
          @if (debts().length > 0) {
          <div class="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="space-y-4 sm:space-y-6">
              @for (debt of debts(); track debt.id) {
              <div class="relative p-4 sm:p-5 rounded-lg sm:rounded-xl border-2 border-primary/20 bg-white dark:bg-slate-800/50 shadow-sm transition-all hover:shadow-md min-w-0">
                <!-- Header de la deuda -->
                <div class="flex flex-wrap items-start justify-between gap-2 mb-3 sm:mb-4">
                  <div class="flex items-center gap-2 sm:gap-3 min-w-0">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full border-2 border-primary flex items-center justify-center shrink-0">
                      <i class="pi pi-file text-primary text-base sm:text-xl"></i>
                    </div>
                    <div class="min-w-0">
                      <h4 class="font-bold text-sm sm:text-base text-slate-900 dark:text-white">Deuda #{{ debt.id }}</h4>
                      <span class="inline-flex items-center px-2 py-0.5 rounded-md text-[10px] sm:text-xs font-bold uppercase mt-0.5 sm:mt-1"
                        [ngClass]="{
                          'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300': debt.status === 'PENDING',
                          'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300': debt.status === 'PARTIALLY_PAID',
                          'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300': debt.status === 'PAID',
                          'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300': debt.status === 'OVERDUE'
                        }">
                        {{ getStatusLabel(debt.status) }}
                      </span>
                    </div>
                  </div>
                  <div class="flex items-center justify-center shrink-0">
                    @if (canEditProviderAndDebts) {
                      <p-button
                        icon="pi pi-ellipsis-v"
                        [text]="true"
                        severity="secondary"
                        [rounded]="true"
                        size="small"
                        (onClick)="debtMenu.toggle($event)"
                        [pTooltip]="'Acciones'"
                        tooltipPosition="top" />
                      <p-menu
                        #debtMenu
                        [model]="getDebtMenuItems(debt)"
                        [popup]="true"
                        [appendTo]="'body'" />
                    }
                  </div>
                </div>

                <!-- Información de la deuda -->
                <div class="grid grid-cols-2 gap-x-2 gap-y-3 sm:gap-y-4">
                  <!-- Monto Inicial -->
                  <div class="flex gap-2 sm:gap-3 min-w-0">
                    <i class="pi pi-dollar text-slate-300 dark:text-slate-500 mt-0.5 sm:mt-1 text-sm sm:text-base shrink-0"></i>
                    <div class="min-w-0">
                      <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 font-medium">Inicial</p>
                      <p class="text-base sm:text-lg font-semibold text-slate-700 dark:text-slate-300 truncate">$ {{ debt.initialAmount.toFixed(2) }}</p>
                    </div>
                  </div>

                  <!-- Monto Restante -->
                  <div class="flex gap-2 sm:gap-3 min-w-0">
                    <i class="pi pi-exclamation-circle text-red-500 mt-0.5 sm:mt-1 text-sm sm:text-base shrink-0"></i>
                    <div class="min-w-0">
                      <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 font-medium">Restante</p>
                      <p class="text-base sm:text-lg font-black text-red-600 dark:text-red-400 truncate">$ {{ debt.remainingAmount.toFixed(2) }}</p>
                    </div>
                  </div>

                  <!-- Fecha de Vencimiento con Semáforo -->
                  <div class="flex gap-2 sm:gap-3 min-w-0">
                    <i class="pi pi-calendar text-slate-300 dark:text-slate-500 mt-0.5 sm:mt-1 text-sm sm:text-base shrink-0"></i>
                    <div class="min-w-0">
                      <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 font-medium">Vencimiento</p>
                      <p class="text-xs sm:text-sm font-bold flex items-center gap-1" 
                        [ngClass]="{
                          'text-red-600 dark:text-red-400': getDueDateStatus(debt) === 'danger',
                          'text-yellow-600 dark:text-yellow-400': getDueDateStatus(debt) === 'warning',
                          'text-green-600 dark:text-green-400': getDueDateStatus(debt) === 'safe',
                          'text-slate-700 dark:text-slate-300': getDueDateStatus(debt) !== 'danger' && getDueDateStatus(debt) !== 'warning' && getDueDateStatus(debt) !== 'safe'
                        }">
                        {{ debt.dueDate | date:'dd/MM/yyyy' }}
                        @if (getDueDateStatus(debt) === 'danger') {
                          <i class="pi pi-exclamation-triangle text-xs"></i>
                        }
                      </p>
                    </div>
                  </div>

                  <!-- Pagos Activos -->
                  <div class="flex gap-2 sm:gap-3 min-w-0">
                    <i class="pi pi-check-circle text-slate-300 dark:text-slate-500 mt-0.5 sm:mt-1 text-sm sm:text-base shrink-0"></i>
                    <div class="min-w-0">
                      <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 font-medium">Pagos Activos</p>
                      <p class="text-xs sm:text-sm font-bold text-slate-700 dark:text-slate-300">{{ getActivePaymentsCount(debt) }}</p>
                    </div>
                  </div>
                </div>

                <!-- Botón Ver Detalles -->
                @if (debt.orderId) {
                <div class="mt-3 sm:mt-4 pt-3 sm:pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end">
                  <a 
                    (click)="onViewOrderDetail(debt)"
                    class="text-[10px] sm:text-xs font-semibold text-primary hover:text-blue-700 dark:text-blue-400 flex items-center gap-1 group cursor-pointer">
                    Ver Detalles de Pagos
                    <i class="pi pi-arrow-right text-[10px] sm:text-xs group-hover:translate-x-0.5 transition-transform"></i>
                  </a>
                </div>
                }
              </div>
              }
            </div>

            <!-- Mensaje informativo -->
            <div class="mt-4 sm:mt-6 bg-blue-50 dark:bg-slate-800 p-2.5 sm:p-3 rounded-lg border-l-4 border-primary">
              <p class="text-[10px] sm:text-xs text-slate-600 dark:text-slate-400 flex items-start gap-2">
                <i class="pi pi-info-circle text-primary text-xs sm:text-sm mt-0.5 shrink-0"></i>
                <span>Existen pagos pendientes por procesar para este proveedor.</span>
              </p>
            </div>
          </div>
          } @else {
          <div class="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-xs sm:text-sm text-gray-500 dark:text-gray-400 text-center py-3 sm:py-4">
              No hay deudas registradas para este proveedor.
            </p>
          </div>
          }

          <!-- Botón Exportar Reporte -->
          <div class="px-4 sm:px-6 py-3 sm:py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50">
            <p-button
              label="Exportar Reporte"
              icon="pi pi-download"
              [severity]="'success'"
              [loading]="isLoading"
              (onClick)="onExportReport()"
              class="w-full" />
          </div>
        </app-app-card>
      </div>

      <!-- Columna Derecha: Formulario de Pedido -->
      <app-app-card class="mt-0 min-w-0 card-no-padding" styleClass="border-primary/20 dark:border-primary/30 relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-primary"></div>
        <div class="relative z-10 px-4 py-3 sm:px-6 sm:py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50 flex flex-nowrap items-center justify-between gap-2 min-h-[3rem]">
          <h3 class="text-base sm:text-lg font-semibold text-primary dark:text-blue-400 truncate min-w-0">
            {{ editingOrderId() ? 'Editar Pedido' : 'Añadir Nuevo Pedido' }}
          </h3>
          @if (!editingOrderId()) {
          <i class="pi pi-plus-circle text-primary/50 text-xl sm:text-2xl shrink-0"></i>
          } @else {
          <i class="pi pi-pencil text-primary/50 text-xl sm:text-2xl shrink-0"></i>
          }
        </div>

        <div class="p-4 sm:p-6 space-y-4 sm:space-y-6">
        <form [formGroup]="orderForm" (ngSubmit)="onAddOrder()" class="space-y-4 sm:space-y-6">
          <div>
            <label class="block text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-300 mb-0.5 sm:mb-1" for="dispatch-date">Fecha
              de Despacho</label>
            <p-datePicker id="dispatch-date" formControlName="fechaDespacho" [showIcon]="true" dateFormat="dd/mm/yy"
              styleClass="w-full" />
            @if (orderForm.get('fechaDespacho')?.invalid && orderForm.get('fechaDespacho')?.touched) {
            <small class="text-red-600">La fecha es requerida</small>
            }
          </div>

          <div>
            <label class="block text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-300 mb-0.5 sm:mb-1" for="credit-days">Días de
              Crédito</label>
            <div class="relative">
              <p-inputNumber id="credit-days" formControlName="diasCredito" [min]="0" placeholder="ej. 30"
                class="w-full" />
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">Días</span>
            </div>
            @if (orderForm.get('diasCredito')?.invalid && orderForm.get('diasCredito')?.touched) {
            <small class="text-red-600">Los días de crédito son requeridos</small>
            }
          </div>

          <div>
            <label class="block text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-300 mb-0.5 sm:mb-1" for="due-date">Fecha de vencimiento</label>
            <p-iconfield iconPosition="left" class="w-full">
              <p-inputicon>
                <i class="pi pi-calendar-times"></i>
              </p-inputicon>
              <input
                id="due-date"
                type="text"
                pInputText
                [value]="fechaVencimiento() ? (fechaVencimiento() | date:'dd/MM/yyyy') : '—'"
                readonly
                class="w-full bg-gray-100 dark:bg-gray-800 cursor-not-allowed" />
            </p-iconfield>
            <p class="text-[10px] sm:text-xs text-slate-500 dark:text-slate-400 mt-0.5 sm:mt-1">
              Calculado a partir de la fecha de despacho y los días de crédito.
            </p>
          </div>

          <div>
            <label class="block text-xs sm:text-sm font-medium text-slate-700 dark:text-slate-300 mb-0.5 sm:mb-1" for="amount">Monto ($)</label>
            <p-iconfield iconPosition="left" class="w-full">
              <p-inputicon>
                <span class="text-gray-500 dark:text-gray-400 font-bold">$</span>
              </p-inputicon>
              <p-inputNumber id="amount" formControlName="monto" mode="decimal" [minFractionDigits]="2"
                [maxFractionDigits]="2" placeholder="0.00" currency="USD" styleClass="w-full" />
            </p-iconfield>
            <p class="mt-0.5 sm:mt-1 text-[10px] sm:text-xs text-slate-500 dark:text-slate-400">
              {{ editingOrderId() ? 'Monto inicial de la deuda.' : 'Este monto se aumentará a la deuda actual.' }}
            </p>
            @if (orderForm.get('monto')?.invalid && orderForm.get('monto')?.touched) {
            <small class="text-red-600">El monto es requerido</small>
            }
          </div>

          <div class="pt-3 sm:pt-4 flex flex-wrap items-center justify-end gap-2 sm:gap-3">
            <p-button label="Cancelar" severity="secondary" (onClick)="onCancel()" />
            <p-button
              type="submit"
              [label]="editingOrderId() ? 'Actualizar Pedido' : 'Agregar Pedido'"
              [icon]="editingOrderId() ? 'pi pi-check' : 'pi pi-plus'"
              [loading]="isLoading"
              [disabled]="orderForm.invalid" />
          </div>
        </form>
        </div>
      </app-app-card>
    </div>
    }
  </div>
</app-page-container>

<!-- Modal de confirmación para eliminar distribuidor -->
<app-confirm-dialog
  [visible]="showConfirmDeleteProvider()"
  (visibleChange)="showConfirmDeleteProvider.set($event)"
  title="Eliminar distribuidor"
  message="Si elimina este proveedor se eliminarán también las deudas y pagos relacionados. ¿Está seguro que desea eliminar este distribuidor?"
  confirmLabel="Eliminar"
  cancelLabel="Cancelar"
  severity="danger"
  icon="pi pi-trash"
  (onConfirm)="onConfirmDeleteProvider()"
  (onCancel)="onCancelDeleteProvider()" />

<!-- Modal de confirmación para eliminar deuda -->
<app-confirm-dialog
  [visible]="showConfirmDeleteDebt()"
  (visibleChange)="showConfirmDeleteDebt.set($event)"
  title="Eliminar deuda"
  message="¿Está seguro que desea eliminar esta deuda?"
  confirmLabel="Eliminar"
  cancelLabel="Cancelar"
  severity="danger"
  icon="pi pi-trash"
  (onConfirm)="onConfirmDeleteDebt()"
  (onCancel)="onCancelDeleteDebt()" />