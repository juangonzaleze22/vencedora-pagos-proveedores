<app-app-header title="Localizar Proveedor y Pedidos" subtitle="Búsqueda y gestión de proveedores" />

<p-toast />

<app-page-container maxWidth="6xl">
  <div class="mb-6 flex items-center text-sm text-gray-500 dark:text-gray-400">
    <p-button 
      icon="pi pi-arrow-left"
      label="Volver al Dashboard"
      [text]="true"
      (onClick)="onBackToDashboard()" />
  </div>

  <div class="min-h-screen" style="display: flex; flex-direction: column; gap: 1rem;">
    <!-- Búsqueda -->
    <app-app-card >
      <div class="max-w-2xl ">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" for="supplier-search">
          Buscar Distribuidor
        </label>
        <app-supplier-autocomplete
          placeholder="Ej: Nombre de la empresa o RIF"
          [suggestions]="supplierSuggestions"
          [loading]="searchLoading"
          (search)="onSearch($event)"
          (select)="onSupplierSelect($event)"
          (focus)="onFocus()">
        </app-supplier-autocomplete>
        <p class="mt-2 text-xs text-gray-500 dark:text-gray-400 flex items-center gap-1">
          <i class="pi pi-info-circle text-sm"></i>
          Haga clic en el campo para ver todos los distribuidores o escriba para buscar.
        </p>
      </div>
    </app-app-card>

    <!-- Resultados -->
    @if (provider) {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
      <!-- Columna Izquierda: Resumen y Deudas -->
      <div class="space-y-0">
        <app-app-card class="card-no-padding">
          <!-- Resumen del Proveedor -->
          <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50 flex items-center gap-2">
            <i class="pi pi-info-circle text-primary text-lg"></i>
            <h3 class="text-lg font-semibold text-slate-800 dark:text-white">Resumen del Proveedor</h3>
          </div>

          <div class="p-6 space-y-6">
            <!-- Información del Proveedor -->
            <div>
              <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                Nombre Proveedor
              </label>
              <div class="text-2xl font-bold text-slate-900 dark:text-white">
                {{ provider!.companyName }}
              </div>
            </div>

            @if (provider!.taxId) {
            <div>
              <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                RIF / ID Fiscal
              </label>
              <div class="text-lg text-slate-800 dark:text-slate-200 font-medium">
                {{ provider!.taxId }}
              </div>
            </div>
            }

                  <div [ngClass]="{
                    'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-800/30': totalDebt() > 0,
                    'bg-green-50 dark:bg-green-900/20 border-green-100 dark:border-green-800/30': totalDebt() <= 0
                  }" class="p-4 rounded-lg border">
                    <label [ngClass]="totalDebt() > 0 ? 'text-red-600 dark:text-red-400' : 'text-green-600 dark:text-green-400'" 
                      class="block text-xs font-medium uppercase tracking-wider mb-1">
                      Deuda Actualizada
                    </label>
                    <div [ngClass]="totalDebt() > 0 ? 'text-red-700 dark:text-red-400' : 'text-green-700 dark:text-green-400'" 
                      class="text-2xl font-bold font-mono">
                      $ {{ totalDebt().toFixed(2) }}
                    </div>
                    @if (totalDebt() > 0) {
                      <p class="text-xs text-red-500 mt-1">Requiere atención</p>
                    } @else {
                      <p class="text-xs text-green-500 mt-1">Al día / Sin deudas</p>
                    }
                  </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                  Estado
                </label>
                <div class="text-base text-slate-800 dark:text-slate-200 font-medium flex items-center gap-2">
                  <i class="pi pi-info-circle text-blue-500 text-sm"></i>
                  {{ provider!.status === 'PENDING' ? 'Pendiente' : 'Completado' }}
                </div>
              </div>
              <div>
                <label class="block text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider mb-1">
                  Último Pago/Abono
                </label>
                <div class="text-base text-slate-800 dark:text-slate-200 font-medium">
                  {{ provider!.lastPaymentDate ? (provider!.lastPaymentDate | date:'dd/MM/yyyy') : 'N/A' }}
                </div>
              </div>
            </div>
          </div>

          <!-- Lista de Deudas -->
          @if (debts().length > 0) {
          <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <div class="space-y-6">
              @for (debt of debts(); track debt.id) {
              <div class="relative p-5 rounded-xl border-2 border-primary/20 bg-white dark:bg-slate-800/50 shadow-sm transition-all hover:shadow-md">
                <!-- Header de la deuda -->
                <div class="flex items-start justify-between mb-4">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full border-2 border-primary flex items-center justify-center">
                      <i class="pi pi-file text-primary text-xl"></i>
                    </div>
                    <div>
                      <h4 class="font-bold text-slate-900 dark:text-white">Deuda #{{ debt.id }}</h4>
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-bold uppercase mt-1"
                        [ngClass]="{
                          'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300': debt.status === 'PENDING',
                          'bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300': debt.status === 'PARTIALLY_PAID',
                          'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300': debt.status === 'PAID',
                          'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300': debt.status === 'OVERDUE'
                        }">
                        {{ getStatusLabel(debt.status) }}
                      </span>
                    </div>
                  </div>
                  <button class="p-2 text-slate-400 hover:text-primary hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full transition-colors">
                    <i class="pi pi-credit-card"></i>
                  </button>
                </div>

                <!-- Información de la deuda -->
                <div class="grid grid-cols-2 gap-y-4">
                  <!-- Monto Inicial -->
                  <div class="flex gap-3">
                    <i class="pi pi-dollar text-slate-300 dark:text-slate-500 mt-1"></i>
                    <div>
                      <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Inicial</p>
                      <p class="text-lg font-semibold text-slate-700 dark:text-slate-300">$ {{ debt.initialAmount.toFixed(2) }}</p>
                    </div>
                  </div>

                  <!-- Monto Restante -->
                  <div class="flex gap-3">
                    <i class="pi pi-exclamation-circle text-red-500 mt-1"></i>
                    <div>
                      <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Restante</p>
                      <p class="text-lg font-black text-red-600 dark:text-red-400">$ {{ debt.remainingAmount.toFixed(2) }}</p>
                    </div>
                  </div>

                  <!-- Fecha de Vencimiento con Semáforo -->
                  <div class="flex gap-3">
                    <i class="pi pi-calendar text-slate-300 dark:text-slate-500 mt-1"></i>
                    <div>
                      <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Vencimiento</p>
                      <p class="text-sm font-bold flex items-center gap-1" 
                        [ngClass]="{
                          'text-red-600 dark:text-red-400': getDueDateStatus(debt) === 'danger',
                          'text-yellow-600 dark:text-yellow-400': getDueDateStatus(debt) === 'warning',
                          'text-green-600 dark:text-green-400': getDueDateStatus(debt) === 'safe',
                          'text-slate-700 dark:text-slate-300': getDueDateStatus(debt) !== 'danger' && getDueDateStatus(debt) !== 'warning' && getDueDateStatus(debt) !== 'safe'
                        }">
                        {{ debt.dueDate | date:'dd/MM/yyyy' }}
                        @if (getDueDateStatus(debt) === 'danger') {
                          <i class="pi pi-exclamation-triangle text-xs"></i>
                        }
                      </p>
                    </div>
                  </div>

                  <!-- Pagos Activos -->
                  <div class="flex gap-3">
                    <i class="pi pi-check-circle text-slate-300 dark:text-slate-500 mt-1"></i>
                    <div>
                      <p class="text-xs text-slate-500 dark:text-slate-400 font-medium">Pagos Activos</p>
                      <p class="text-sm font-bold text-slate-700 dark:text-slate-300">{{ getActivePaymentsCount(debt) }}</p>
                    </div>
                  </div>
                </div>

                <!-- Botón Ver Detalles -->
                @if (debt.orderId) {
                <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-end">
                  <a 
                    (click)="onViewOrderDetail(debt)"
                    class="text-xs font-semibold text-primary hover:text-blue-700 dark:text-blue-400 flex items-center gap-1 group cursor-pointer">
                    Ver Detalles de Pagos
                    <i class="pi pi-arrow-right text-xs group-hover:translate-x-0.5 transition-transform"></i>
                  </a>
                </div>
                }
              </div>
              }
            </div>

            <!-- Mensaje informativo -->
            <div class="mt-6 bg-blue-50 dark:bg-slate-800 p-3 rounded-lg border-l-4 border-primary">
              <p class="text-xs text-slate-600 dark:text-slate-400 flex items-start gap-2">
                <i class="pi pi-info-circle text-primary text-sm mt-0.5"></i>
                Existen pagos pendientes por procesar para este proveedor.
              </p>
            </div>
          </div>
          } @else {
          <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">
              No hay deudas registradas para este proveedor.
            </p>
          </div>
          }

          <!-- Botón Exportar Reporte -->
          <div class="px-6 py-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-slate-800/50">
            <p-button
              label="Exportar Reporte"
              icon="pi pi-download"
              [severity]="'success'"
              [loading]="isLoading"
              (onClick)="onExportReport()"
              class="w-full" />
          </div>
        </app-app-card>
      </div>

      <!-- Columna Derecha: Formulario de Pedido -->
      <app-app-card class="mt-0" styleClass="border-primary/20 dark:border-primary/30 relative">
        <div class="absolute top-0 left-0 w-full h-1 bg-primary"></div>
        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
          <h3 class="text-lg font-semibold text-primary dark:text-blue-400">Añadir Nuevo Pedido</h3>
          <i class="pi pi-plus-circle text-primary/50 text-2xl"></i>
        </div>

        <div class="p-6">
        <form [formGroup]="orderForm" (ngSubmit)="onAddOrder()" class="space-y-5">
          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="dispatch-date">Fecha
              de Despacho</label>
            <p-datePicker id="dispatch-date" formControlName="fechaDespacho" [showIcon]="true" dateFormat="dd/mm/yy"
              styleClass="w-full" />
            @if (orderForm.get('fechaDespacho')?.invalid && orderForm.get('fechaDespacho')?.touched) {
            <small class="text-red-600">La fecha es requerida</small>
            }
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="credit-days">Días de
              Crédito</label>
            <div class="relative">
              <p-inputNumber id="credit-days" formControlName="diasCredito" [min]="0" placeholder="ej. 30"
                class="w-full" />
              <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">Días</span>
            </div>
            @if (orderForm.get('diasCredito')?.invalid && orderForm.get('diasCredito')?.touched) {
            <small class="text-red-600">Los días de crédito son requeridos</small>
            }
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1" for="amount">Monto ($)</label>
            <p-iconfield iconPosition="left" class="w-full">
              <p-inputicon>
                <span class="text-gray-500 dark:text-gray-400 font-bold">$</span>
              </p-inputicon>
              <p-inputNumber id="amount" formControlName="monto" mode="decimal" [minFractionDigits]="2"
                [maxFractionDigits]="2" placeholder="0.00" currency="USD" styleClass="w-full" />
            </p-iconfield>
            <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Este monto se aumentará a la deuda actual.</p>
            @if (orderForm.get('monto')?.invalid && orderForm.get('monto')?.touched) {
            <small class="text-red-600">El monto es requerido</small>
            }
          </div>

          <div class="pt-4 flex items-center justify-end gap-3">
            <p-button label="Cancelar" severity="secondary" (onClick)="onCancel()" />
            <p-button type="submit" label="+ Agregar Pedido" icon="pi pi-plus" [loading]="isLoading"
              [disabled]="orderForm.invalid" />
          </div>
        </form>
        </div>
      </app-app-card>
    </div>
    }
  </div>
</app-page-container>