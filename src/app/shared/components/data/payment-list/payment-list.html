@if (loading) {
  <div class="flex justify-center py-12">
    <i class="pi pi-spin pi-spinner text-2xl text-primary"></i>
  </div>
} @else if (payments.length === 0) {
  <p class="text-center py-8 text-gray-500 dark:text-gray-400 text-sm">
    {{ emptyMessage }}
  </p>
} @else {
  <!-- Responsive: cards (grid 2 columnas) -->
  <div class="lg:hidden p-3 sm:p-4 grid grid-cols-1 sm:grid-cols-2 gap-4">
    @for (payment of payments; track payment.id) {
      <div
        class="rounded-xl border-2 p-4 space-y-3 min-w-0"
        [ngClass]="{
          'opacity-70 bg-red-50/30 dark:bg-red-900/20 border-red-500 border-l-4': payment.deleted,
          'bg-green-50 dark:bg-green-900/20 border-green-500 border-l-4': !payment.deleted && payment.shared,
          'border-gray-200 dark:border-gray-700 bg-white dark:bg-zinc-800/50': !payment.deleted && !payment.shared
        }">
        <div class="flex items-start justify-between gap-2">
          <div class="min-w-0 flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              @if (payment.deleted) {
                <span class="text-xs font-medium text-gray-500 line-through">#{{ payment.id }}</span>
              } @else {
                <span
                  class="text-xs font-medium text-primary cursor-pointer hover:underline"
                  (click)="viewDetail.emit(payment)">
                  #{{ payment.id }}
                </span>
              }
              @if (payment.senderName) {
                <span
                  class="text-sm font-semibold"
                  [ngClass]="{'line-through text-gray-500': payment.deleted, 'text-slate-900 dark:text-white': !payment.deleted}">
                  {{ payment.senderName }}
                </span>
              }
              @if (!payment.deleted && payment.shared) {
                <span
                  class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-800/60 dark:text-green-200"
                  title="Compartido por WhatsApp">
                  <i class="pi pi-whatsapp text-sm"></i>
                  Compartido
                </span>
              }
            </div>
            @if (payment.senderEmail) {
              <a
                [href]="'mailto:' + payment.senderEmail"
                class="text-xs text-primary hover:underline mt-0.5 block"
                [ngClass]="{'line-through text-gray-500': payment.deleted}"
                (click)="$event.stopPropagation()">
                {{ payment.senderEmail }}
              </a>
            } @else if (payment.senderName) {
              <span class="text-xs text-gray-400 dark:text-gray-500 mt-0.5 block">Sin correo</span>
            }
          </div>
          @if (viewOnly) {
            @if (!payment.deleted) {
              <p-button
                icon="pi pi-eye"
                [text]="true"
                severity="secondary"
                size="small"
                [rounded]="true"
                pTooltip="Ver detalle"
                tooltipPosition="top"
                (onClick)="viewDetail.emit(payment)" />
            } @else {
              <span
                class="text-xs text-gray-500"
                [pTooltip]="getDeletedPaymentTooltip(payment)"
                tooltipPosition="top">
                <i class="pi pi-trash"></i>
              </span>
            }
          } @else if (menuItemsProvider) {
            <div class="shrink-0">
              <p-button
                icon="pi pi-ellipsis-v"
                [text]="true"
                severity="secondary"
                [rounded]="true"
                size="small"
                (onClick)="paymentMenuMobile.toggle($event)"
                [pTooltip]="'Acciones'"
                tooltipPosition="top" />
              <p-menu
                #paymentMenuMobile
                [model]="menuItemsProvider(payment)"
                [popup]="true"
                [appendTo]="'body'" />
            </div>
          }
        </div>
        <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-2 text-sm">
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 block">Fecha</span>
            <span [ngClass]="{'line-through text-gray-500': payment.deleted}">
              {{ payment.paymentDate | date:'dd/MM/yyyy' }}
            </span>
          </div>
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 block">Método</span>
            <span
              class="px-1.5 py-0.5 rounded text-xs font-medium inline-block w-fit"
              [ngClass]="{
                'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200': payment.paymentMethod === 'Zelle' && !payment.deleted,
                'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': payment.paymentMethod === 'Transferencia' && !payment.deleted,
                'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': payment.paymentMethod === 'Efectivo' && !payment.deleted,
                'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 line-through': payment.deleted
              }">
              {{ payment.paymentMethod }}
            </span>
            @if (payment.isBolivares && payment.exchangeRate) {
              <span class="text-[10px] text-gray-500 dark:text-gray-400 block">Tasa: Bs {{ payment.exchangeRate | number:'1.2-2' }}</span>
            }
          </div>
          <div>
            <span class="text-xs text-gray-500 dark:text-gray-400 block">Monto</span>
            <span class="font-semibold" [ngClass]="{'line-through text-gray-500': payment.deleted}">
              $ {{ payment.amount.toFixed(2) }}
            </span>
            @if (payment.isBolivares && payment.amountInBolivares) {
              <span class="text-[10px] text-gray-500 dark:text-gray-400 block">Bs {{ payment.amountInBolivares | number:'1.2-2' }}</span>
            }
          </div>
        </div>
        <!-- Comprobantes en fila separada -->
        @if (payment.receiptFiles && payment.receiptFiles.length > 0) {
          <div class="mt-2 text-sm">
            <span class="text-xs text-gray-500 dark:text-gray-400 block mb-1">Comprobantes</span>
            <div class="flex gap-2" [ngClass]="{'opacity-50': payment.deleted}">
              @for (url of payment.receiptFiles; track $index) {
                <app-lazy-image
                  [src]="url"
                  [alt]="'Comprobante #' + payment.id + ' (' + ($index + 1) + ')'"
                  width="60px"
                  height="60px"
                  objectFit="cover"
                  [rounded]="true"
                  [preview]="true" />
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

  <!-- Desktop: tabla -->
  <div class="hidden lg:block overflow-x-auto p-4">
    <p-table [value]="payments" [loading]="loading" styleClass="p-datatable-striped p-datatable-sm">
      <ng-template pTemplate="header">
        <tr>
          <th class="text-xs font-semibold align-middle">Contacto</th>
          <th class="text-xs font-semibold align-middle">Fecha</th>
          <th class="text-xs font-semibold align-middle">Método</th>
          <th class="text-xs font-semibold align-middle">Monto</th>
          <th class="text-xs font-semibold text-center align-middle">Comprobante</th>
          <th class="text-xs font-semibold text-center align-middle" [class.w-20]="viewOnly">{{ viewOnly ? 'Ver' : 'Acciones' }}</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-payment>
        <tr
          [ngClass]="{
            'opacity-70': payment.deleted,
            'row-deleted': payment.deleted,
            'row-shared-whatsapp': !payment.deleted && payment.shared
          }">
          <td class="py-2 align-middle">
            <div class="flex flex-col gap-0.5">
              <div class="flex items-center gap-2 flex-wrap">
                @if (payment.deleted) {
                  <span class="text-xs font-medium text-gray-500 line-through">#{{ payment.id }}</span>
                } @else {
                  <span
                    class="text-xs font-medium cursor-pointer hover:underline text-primary"
                    (click)="viewDetail.emit(payment)">
                    #{{ payment.id }}
                  </span>
                }
                @if (payment.senderName) {
                  <span
                    class="text-sm font-medium"
                    [ngClass]="{'line-through text-gray-500': payment.deleted}">
                    {{ payment.senderName }}
                  </span>
                }
                @if (!payment.deleted && payment.shared) {
                  <span
                    class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-800/60 dark:text-green-200 w-fit"
                    title="Compartido por WhatsApp">
                    <i class="pi pi-whatsapp text-sm"></i>
                    Compartido
                  </span>
                }
              </div>
              @if (payment.senderEmail) {
                <a
                  [href]="'mailto:' + payment.senderEmail"
                  class="text-xs text-primary hover:underline"
                  [ngClass]="{'line-through text-gray-500': payment.deleted}"
                  (click)="$event.stopPropagation()">
                  {{ payment.senderEmail }}
                </a>
              } @else if (payment.senderName) {
                <span class="text-xs text-gray-400 dark:text-gray-500">Sin correo</span>
              }
            </div>
          </td>
          <td class="text-sm py-2 align-middle" [ngClass]="{'line-through text-gray-500': payment.deleted}">
            {{ payment.paymentDate | date:'dd/MM/yyyy' }}
          </td>
          <td class="py-2 align-middle">
            <div class="flex flex-col gap-0.5">
              <span
                class="px-1.5 py-0.5 rounded text-xs font-medium inline-block w-fit"
                [ngClass]="{
                  'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200': payment.paymentMethod === 'Zelle' && !payment.deleted,
                  'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200': payment.paymentMethod === 'Transferencia' && !payment.deleted,
                  'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200': payment.paymentMethod === 'Efectivo' && !payment.deleted,
                  'bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 line-through': payment.deleted
                }">
                {{ payment.paymentMethod }}
              </span>
              @if (payment.isBolivares && payment.exchangeRate) {
                <span class="text-[10px] text-gray-500 dark:text-gray-400 leading-tight">
                  Tasa: Bs {{ payment.exchangeRate | number:'1.2-2' }}
                </span>
              }
            </div>
          </td>
          <td class="py-2 align-middle">
            <div class="flex flex-col gap-0.5">
              <span
                class="text-sm font-semibold"
                [ngClass]="{'line-through text-gray-500': payment.deleted}">
                $ {{ payment.amount.toFixed(2) }}
              </span>
              @if (payment.isBolivares && payment.amountInBolivares) {
                <span class="text-[10px] text-gray-500 dark:text-gray-400 leading-tight">
                  Bs {{ payment.amountInBolivares | number:'1.2-2' }}
                </span>
              }
            </div>
          </td>
          <td class="text-center py-2 align-middle">
            <div class="flex items-center justify-center gap-1">
              @if (payment.receiptFiles && payment.receiptFiles.length > 0) {
                @for (url of payment.receiptFiles; track $index) {
                  <div [ngClass]="{'opacity-50': payment.deleted}">
                    <app-lazy-image
                      [src]="url"
                      [alt]="'Comprobante #' + payment.id + ' (' + ($index + 1) + ')'"
                      width="48px"
                      height="48px"
                      objectFit="cover"
                      [rounded]="true"
                      [preview]="true" />
                  </div>
                }
              } @else {
                <span class="text-xs text-gray-400">—</span>
              }
            </div>
          </td>
          <td class="py-2 align-middle text-center">
            @if (viewOnly) {
              @if (!payment.deleted) {
                <p-button
                  icon="pi pi-eye"
                  [text]="true"
                  severity="secondary"
                  size="small"
                  pTooltip="Ver detalle"
                  tooltipPosition="top"
                  (onClick)="viewDetail.emit(payment)" />
              } @else {
                <span
                  class="text-xs text-gray-500"
                  [pTooltip]="getDeletedPaymentTooltip(payment)"
                  tooltipPosition="top">
                  <i class="pi pi-trash"></i>
                </span>
              }
            } @else if (menuItemsProvider) {
              <div class="flex items-center justify-center">
                <p-button
                  icon="pi pi-ellipsis-v"
                  [text]="true"
                  severity="secondary"
                  [rounded]="true"
                  size="small"
                  (onClick)="paymentMenu.toggle($event)"
                  [pTooltip]="'Acciones'"
                  tooltipPosition="top" />
                <p-menu
                  #paymentMenu
                  [model]="menuItemsProvider(payment)"
                  [popup]="true"
                  [appendTo]="'body'" />
              </div>
            }
          </td>
        </tr>
      </ng-template>
      @if (payments.length === 0) {
        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-8 text-gray-500">{{ emptyMessage }}</td>
          </tr>
        </ng-template>
      }
    </p-table>
  </div>
}
