<app-app-header title="Cierre de Caja" subtitle="Resumen de pagos procesados por cajero" />

<app-page-container>
  <p-toast />

  <!-- Filtros -->
  <div class="bg-surface-light dark:bg-surface-dark rounded-lg border border-gray-200 dark:border-gray-700 p-4 mb-6 shadow-sm">
    <div class="flex flex-wrap items-end gap-4">
      <!-- Selector de Cajero -->
      <div class="flex-1 min-w-[200px]">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">
          Cajero
        </label>
        <p-select
          [options]="cashiers()"
          [ngModel]="selectedCashierId()"
          (ngModelChange)="onCashierChange($event)"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Seleccionar cajero..."
          [filter]="true"
          filterBy="nombre,email"
          [showClear]="false"
          [loading]="loadingCashiers()"
          class="w-full"
          styleClass="w-full">
          <ng-template #selectedItem let-item>
            <div class="flex items-center gap-2" *ngIf="item">
              <i class="pi pi-user text-primary"></i>
              <span>{{ item.nombre }}</span>
              <span class="text-xs text-gray-400">({{ item.email }})</span>
            </div>
          </ng-template>
          <ng-template #item let-item>
            <div class="flex items-center gap-2">
              <i class="pi pi-user"></i>
              <div>
                <div class="font-medium">{{ item.nombre }}</div>
                <div class="text-xs text-gray-500">{{ item.email }}</div>
              </div>
            </div>
          </ng-template>
        </p-select>
      </div>

      <!-- Rango de Fechas -->
      <div class="min-w-[220px]">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">
          Rango de Fechas
        </label>
        <p-datepicker
          [ngModel]="dateRange()"
          (ngModelChange)="onDateRangeChange($event)"
          selectionMode="range"
          dateFormat="dd/mm/yy"
          placeholder="Desde - Hasta"
          [showIcon]="true"
          [showButtonBar]="true"
          [showClear]="true"
          (onClear)="onDateRangeClear()"
          styleClass="w-full"
          [readonlyInput]="true" />
      </div>

      <!-- Método de Pago -->
      <div class="min-w-[180px]">
        <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-1.5">
          Método de Pago
        </label>
        <p-select
          [options]="paymentMethodOptions"
          [ngModel]="selectedPaymentMethod()"
          (ngModelChange)="onPaymentMethodChange($event)"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos"
          styleClass="w-full" />
      </div>

      <!-- Incluir eliminados -->
      <div class="flex items-center gap-2 pb-1">
        <p-checkbox
          [ngModel]="includeDeleted()"
          (ngModelChange)="includeDeleted.set($event); onIncludeDeletedChange()"
          [binary]="true"
          inputId="includeDeleted" />
        <label for="includeDeleted" class="text-sm text-gray-600 dark:text-gray-300 cursor-pointer whitespace-nowrap">
          Incluir eliminados
        </label>
      </div>

      <!-- Botones de acción -->
      <div class="flex gap-2 pb-0.5">
        <p-button
          icon="pi pi-refresh"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          pTooltip="Actualizar"
          (onClick)="refresh()"
          [disabled]="!selectedCashierId() || loading()" />
        <p-button
          icon="pi pi-filter-slash"
          [rounded]="true"
          [text]="true"
          severity="secondary"
          pTooltip="Limpiar filtros"
          (onClick)="clearFilters()"
          [disabled]="!selectedCashierId()" />
      </div>
    </div>
  </div>

  <!-- Estado vacío: sin cajero seleccionado -->
  @if (!selectedCashierId()) {
    <div class="flex flex-col items-center justify-center py-20 text-gray-400 dark:text-gray-500">
      <i class="pi pi-inbox text-5xl mb-4"></i>
      <p class="text-lg font-medium">Seleccione un cajero</p>
      <p class="text-sm">Elija un cajero de la lista para ver su resumen de pagos</p>
    </div>
  }

  <!-- Loader -->
  @if (loading()) {
    <div class="flex items-center justify-center py-16">
      <p-progressSpinner strokeWidth="3" styleClass="w-12 h-12" />
    </div>
  }

  <!-- Contenido principal (cuando hay datos) -->
  @if (hasData() && !loading()) {
    <!-- Información del cajero -->
    <div class="flex items-center gap-3 mb-6">
      <div class="h-10 w-10 rounded-full bg-primary text-white flex items-center justify-center font-bold text-sm">
        {{ cashierInfo()?.nombre?.charAt(0)?.toUpperCase() || 'C' }}
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">
          {{ cashierInfo()?.nombre || cashierInfo()?.email }}
        </h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">
          {{ cashierInfo()?.email }} · {{ cashierInfo()?.rol }}
        </p>
      </div>
    </div>

    <!-- KPI Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
      <app-stat-card
        label="Total de Pagos"
        [value]="formatNumber(kpis()?.totalPayments)"
        icon="pi pi-receipt"
        iconColor="blue" />
      <app-stat-card
        label="Monto Total (USD)"
        [value]="formatCurrency(kpis()?.totalAmount)"
        icon="pi pi-dollar"
        iconColor="green" />
      <app-stat-card
        label="Monto Total (Bs)"
        [value]="formatBolivares(kpis()?.totalAmountInBolivares)"
        icon="pi pi-money-bill"
        iconColor="orange" />
      <app-stat-card
        label="Proveedores Atendidos"
        [value]="formatNumber(kpis()?.suppliersServed)"
        icon="pi pi-users"
        iconColor="yellow" />
    </div>

    <!-- Desglose por Método de Pago -->
    <div class="mb-6">
      <div class="bg-surface-light dark:bg-surface-dark rounded-lg border border-gray-200 dark:border-gray-700 p-5 shadow-sm">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider mb-4">
          <i class="pi pi-wallet mr-2 text-primary"></i>Por Método de Pago
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <!-- Zelle -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800/30">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-blue-100 dark:bg-blue-800/50 flex items-center justify-center">
                <i class="pi pi-dollar text-blue-600 dark:text-blue-400 text-sm"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900 dark:text-white text-sm">Zelle</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ kpis()?.byPaymentMethod?.ZELLE?.count || 0 }} pagos</p>
              </div>
            </div>
            <span class="font-semibold text-blue-700 dark:text-blue-300">
              {{ formatCurrency(kpis()?.byPaymentMethod?.ZELLE?.totalAmount) }}
            </span>
          </div>

          <!-- Transferencia -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-purple-50 dark:bg-purple-900/20 border border-purple-100 dark:border-purple-800/30">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-purple-100 dark:bg-purple-800/50 flex items-center justify-center">
                <i class="pi pi-building-columns text-purple-600 dark:text-purple-400 text-sm"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900 dark:text-white text-sm">Transferencia</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ kpis()?.byPaymentMethod?.TRANSFER?.count || 0 }} pagos</p>
              </div>
            </div>
            <span class="font-semibold text-purple-700 dark:text-purple-300">
              {{ formatCurrency(kpis()?.byPaymentMethod?.TRANSFER?.totalAmount) }}
            </span>
          </div>

          <!-- Efectivo -->
          <div class="flex items-center justify-between p-3 rounded-lg bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800/30">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-full bg-green-100 dark:bg-green-800/50 flex items-center justify-center">
                <i class="pi pi-money-bill text-green-600 dark:text-green-400 text-sm"></i>
              </div>
              <div>
                <p class="font-medium text-gray-900 dark:text-white text-sm">Efectivo</p>
                <p class="text-xs text-gray-500 dark:text-gray-400">{{ kpis()?.byPaymentMethod?.CASH?.count || 0 }} pagos</p>
              </div>
            </div>
            <span class="font-semibold text-green-700 dark:text-green-300">
              {{ formatCurrency(kpis()?.byPaymentMethod?.CASH?.totalAmount) }}
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de Pagos -->
    <div class="bg-surface-light dark:bg-surface-dark rounded-lg border border-gray-200 dark:border-gray-700 shadow-sm overflow-hidden">
      <div class="px-5 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <h3 class="text-sm font-semibold text-gray-900 dark:text-white uppercase tracking-wider">
          <i class="pi pi-list mr-2 text-primary"></i>Detalle de Pagos
        </h3>
        <span class="text-xs text-gray-500 dark:text-gray-400">
          {{ totalRecords() }} registro{{ totalRecords() !== 1 ? 's' : '' }}
        </span>
      </div>

      <p-table
        [value]="payments()"
        [paginator]="true"
        [rows]="pageSize()"
        [totalRecords]="totalRecords()"
        [rowsPerPageOptions]="[10, 20, 50]"
        [lazy]="true"
        [first]="(currentPage() - 1) * pageSize()"
        (onPage)="onPageChange($event)"
        [loading]="loading()"
        [scrollable]="true"
        scrollHeight="flex"
        styleClass="p-datatable-sm p-datatable-striped"
        [tableStyle]="{'min-width': '60rem'}">

        <ng-template #header>
          <tr>
            <th style="width: 60px">#</th>
            <th>Proveedor</th>
            <th>Monto</th>
            <th>Método</th>
            <th>Fecha</th>
            <th># Confirmación</th>
            <th style="width: 60px" class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template #body let-payment>
          <tr [class.opacity-50]="payment.deleted">
            <td class="font-mono text-xs text-gray-500">{{ payment.id }}</td>
            <td>
              <div class="flex flex-col">
                <span class="font-medium text-gray-900 dark:text-white text-sm">
                  {{ payment.supplier?.companyName || 'N/A' }}
                </span>
                @if (payment.supplier?.taxId) {
                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    RIF: {{ payment.supplier.taxId }}
                  </span>
                }
              </div>
            </td>
            <td>
              <div class="flex flex-col">
                <span class="font-semibold text-gray-900 dark:text-white">
                  {{ formatCurrency(payment.amount) }}
                </span>
                @if (payment.isBolivares && payment.amountInBolivares) {
                  <span class="text-xs text-orange-600 dark:text-orange-400">
                    {{ formatBolivares(payment.amountInBolivares) }}
                  </span>
                }
              </div>
            </td>
            <td>
              <div class="flex flex-col">
                <span class="inline-flex items-center gap-1.5 text-sm">
                  <i [class]="getPaymentMethodIcon(payment.paymentMethod === 'Zelle' ? 'ZELLE' : payment.paymentMethod === 'Transferencia' ? 'TRANSFER' : 'CASH')"
                     class="text-xs"></i>
                  {{ getPaymentMethodLabel(payment.paymentMethod) }}
                </span>
                @if (payment.isBolivares && payment.exchangeRate) {
                  <span class="text-xs text-gray-500 dark:text-gray-400">
                    Tasa: Bs {{ payment.exchangeRate | number:'1.2-2' }}
                  </span>
                }
              </div>
            </td>
            <td class="text-sm">{{ payment.paymentDate | date:'dd/MM/yyyy' }}</td>
            <td>
              @if (payment.confirmationNumber) {
                <span class="font-mono text-xs text-gray-700 dark:text-gray-300">
                  {{ payment.confirmationNumber }}
                </span>
              } @else {
                <span class="text-xs text-gray-400">—</span>
              }
            </td>
            <td class="text-center">
              <p-button
                icon="pi pi-external-link"
                [rounded]="true"
                [text]="true"
                severity="secondary"
                size="small"
                pTooltip="Ver detalle"
                (onClick)="openPaymentInNewTab(payment)" />
            </td>
          </tr>
        </ng-template>

        <ng-template #emptymessage>
          <tr>
            <td colspan="7" class="text-center py-8">
              <div class="flex flex-col items-center text-gray-400 dark:text-gray-500">
                <i class="pi pi-inbox text-3xl mb-2"></i>
                <p class="text-sm">No se encontraron pagos con los filtros actuales</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  }

  <!-- Dialog de detalle de pago -->
  @if (selectedPayment()) {
    <app-payment-detail-dialog
      [visible]="showPaymentDetail()"
      [paymentId]="selectedPayment()!.id"
      (visibleChange)="onClosePaymentDetail()" />
  }
</app-page-container>
